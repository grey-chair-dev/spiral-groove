# All SQL Queries (inventory)

This file is auto-generated by scanning the repo for SQL strings passed to the Neon `query()` helper.

- Roots scanned: `api/`, `scripts/`
- File types: `.js`, `.mjs`, `.ts`
- Note: Some queries are template literals and include placeholders like `${...}` (these will be resolved at runtime).

**Total files with queries**: 25  \n**Total unique queries (by file+SQL)**: 127

---

## `api/albumsCache.js` (9)

### L19

```sql
CREATE TABLE IF NOT EXISTS albums_cache (
      id TEXT PRIMARY KEY,
      square_item_id TEXT,
      square_variation_id TEXT,
      name TEXT NOT NULL,
      description TEXT,
      price_cents BIGINT NOT NULL DEFAULT 0,
      price_dollars NUMERIC(10, 2) GENERATED ALWAYS AS (price_cents / 100.0) STORED,
      category TEXT,
      all_categories TEXT[],
      stock_count INTEGER NOT NULL DEFAULT 0,
      image_url TEXT,
      rating NUMERIC(3, 1) DEFAULT 0,
      review_count INTEGER DEFAULT 0,
      sold_count INTEGER NOT NULL DEFAULT 0,
      last_sold_at TIMESTAMPTZ,
      last_stocked_at TIMESTAMPTZ,
      last_adjustment_at TIMESTAMPTZ,
      created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      synced_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      -- Sargable “recent activity” timestamp (used for filtering 0-stock items without OR chains)
      last_active_at TIMESTAMPTZ GENERATED ALWAYS AS (COALESCE(last_stocked_at, created_at)) STORED
    )
```

### L47

```sql
CREATE INDEX IF NOT EXISTS idx_albums_cache_created_desc 
    ON albums_cache (created_at DESC, id ASC)
```

### L52

```sql
CREATE INDEX IF NOT EXISTS idx_albums_cache_stock_count 
    ON albums_cache (stock_count) 
    WHERE stock_count > 0
```

### L58

```sql
CREATE INDEX IF NOT EXISTS idx_albums_cache_zero_stock_recent 
    ON albums_cache (last_stocked_at, created_at DESC) 
    WHERE stock_count = 0
```

### L64

```sql
CREATE INDEX IF NOT EXISTS idx_albums_cache_zero_stock_active 
    ON albums_cache (last_active_at, created_at DESC, id ASC)
    WHERE stock_count = 0
```

### L70

```sql
CREATE INDEX IF NOT EXISTS idx_albums_cache_category_created 
    ON albums_cache (category, created_at DESC, id ASC)
```

### L75

```sql
CREATE INDEX IF NOT EXISTS idx_albums_cache_square_variation_id_unique 
    ON albums_cache (square_variation_id) 
    WHERE square_variation_id IS NOT NULL
```

### L121

```sql
TRUNCATE TABLE albums_cache
```

### L125

```sql
INSERT INTO albums_cache (
      id,
      square_item_id,
      square_variation_id,
      name,
      description,
      price_cents,
      category,
      all_categories,
      stock_count,
      image_url,
      rating,
      review_count,
      sold_count,
      last_sold_at,
      last_stocked_at,
      last_adjustment_at,
      created_at,
      updated_at,
      synced_at
    )
    SELECT 
      id,
      square_item_id,
      square_variation_id,
      name,
      description,
      price_cents,
      category,
      all_categories,
      stock_count,
      image_url,
      rating,
      review_count,
      sold_count,
      last_sold_at,
      last_stocked_at,
      last_adjustment_at,
      created_at,
      updated_at,
      CURRENT_TIMESTAMP as synced_at
    FROM products_cache
    WHERE 
      -- Only albums: category must be in album categories OR all_categories contains vinyl
      -- Include uncategorized items (will be manually updated over time)
      (
        category = ANY($1::text[])
        OR 'New Vinyl' = ANY(all_categories)
        OR 'Used Vinyl' = ANY(all_categories)
        OR category IS NULL  -- Include uncategorized (will be manually updated)
      )
      -- Exclude non-album categories (check both category and all_categories)
      AND (category IS NULL OR category != ALL($2::text[]))
      AND NOT ('DVD' = ANY(all_categories) OR 'DVDs' = ANY(all_categories) OR 'DVD''s' = ANY(all_categories))
      AND NOT ('Videogames' = ANY(all_categories))
      -- Stock filtering: show products with stock OR recently stocked
      AND (
        stock_count > 0
        OR
        (
          stock_count = 0 
          AND (
            (last_stocked_at IS NOT NULL AND last_stocked_at >= $3::timestamptz)
            OR
            (last_stocked_at IS NULL AND created_at >= $3::timestamptz)
          )
        )
      )
```

---

## `api/events.js` (1)

### L67

```sql
SELECT
        id,
        is_event,
        event_type,
        event_name,
        artist,
        venue,
        event_date::text AS date_iso,
        TO_CHAR(event_date, 'MON FMDD') AS date_label,
        start_time::text AS start_time,
        end_time::text AS end_time,
        (event_date::text || 'T' || start_time::text) AS start_datetime_iso,
        (event_date::text || 'T' || end_time::text) AS end_datetime_iso,
        TO_CHAR(start_time, 'FMHH12:MI AM') AS start_time_label,
        TO_CHAR(end_time, 'FMHH12:MI AM') AS end_time_label,
        event_description,
        confidence,
        event_image_url,
        event_permalink,
        fingerprint,
        created_at,
        updated_at
      FROM events
      WHERE is_event = true
        AND event_date >= CURRENT_DATE
      ORDER BY event_date ASC, start_time ASC NULLS LAST, id ASC
```

---

## `api/forgot-password.js` (2)

### L90

```sql
SELECT id FROM users WHERE email = $1
```

### L104

```sql
INSERT INTO password_reset_tokens (user_id, email, token, expires_at, used, created_at)
         VALUES ($1, $2, $3, $4, FALSE, NOW())
```

---

## `api/inventory/log.js` (5)

### L99

```sql
CREATE TABLE IF NOT EXISTS inventory (
        id SERIAL PRIMARY KEY,
        square_variation_id TEXT NOT NULL,
        quantity_change INTEGER NOT NULL,
        reason TEXT,
        notes TEXT,
        created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
      )
```

### L111

```sql
CREATE INDEX IF NOT EXISTS inventory_square_variation_id_idx 
      ON inventory(square_variation_id, created_at DESC)
```

### L116

```sql
CREATE INDEX IF NOT EXISTS inventory_positive_adjustments_idx 
      ON inventory(square_variation_id, created_at DESC) 
      WHERE quantity_change > 0
```

### L123

```sql
INSERT INTO inventory (square_variation_id, quantity_change, reason, notes, created_at)
       VALUES ($1, $2, $3, $4, $5)
       RETURNING id, square_variation_id, quantity_change, reason, notes, created_at
```

### L136

```sql
UPDATE products_cache 
         SET stock_count = stock_count + $1, 
             updated_at = CURRENT_TIMESTAMP,
             last_adjustment_at = $3,
             last_stocked_at = CASE
               -- If stock went from 0 (or null) to > 0, update last_stocked_at
               WHEN (stock_count + $1) > 0 AND (stock_count IS NULL OR stock_count = 0) THEN $3
               -- If stock increased (but was already > 0), update last_stocked_at
               WHEN $1 > 0 AND stock_count > 0 THEN $3
               -- Otherwise keep existing value
               ELSE last_stocked_at
             END
         WHERE square_variation_id = $2
```

---

## `api/newsletter.js` (2)

### L104

```sql
SELECT email, subscribed FROM email_list WHERE email = $1 LIMIT 1
```

### L162

```sql
INSERT INTO email_list (email, first_name, last_name, source, subscribed)
         VALUES ($1, $2, $3, $4, TRUE)
         ON CONFLICT (email) 
         DO UPDATE SET 
           first_name = COALESCE(EXCLUDED.first_name, email_list.first_name),
           last_name = COALESCE(EXCLUDED.last_name, email_list.last_name),
           source = COALESCE(EXCLUDED.source, email_list.source),
           subscribed = TRUE,
           updated_at = NOW()
```

---

## `api/newsletter/unsubscribe.js` (1)

### L94

```sql
DELETE FROM email_list WHERE email = $1
```

---

## `api/orders/update.js` (2)

### L84

```sql
SELECT 
         o.id,
         o.order_number,
         o.square_order_id,
         o.status as current_status,
         o.total_cents,
         o.pickup_details
       FROM orders o
       WHERE o.square_order_id = $1 OR o.order_number = $1 
       LIMIT 1
```

### L129

```sql
UPDATE orders
       SET status = $1, updated_at = CURRENT_TIMESTAMP
       WHERE id = $2
       RETURNING
         id,
         order_number,
         square_order_id,
         status,
         total_cents,
         updated_at,
         pickup_details
```

---

## `api/pay.js` (11)

### L65

```sql
ALTER TABLE products_cache ADD COLUMN IF NOT EXISTS sold_count INTEGER NOT NULL DEFAULT 0
```

### L66

```sql
ALTER TABLE products_cache ADD COLUMN IF NOT EXISTS last_sold_at TIMESTAMPTZ
```

### L99

```sql
UPDATE products_cache pc
       SET sold_count = COALESCE(pc.sold_count, 0) + v.qty,
           last_sold_at = NOW()
       FROM (VALUES ${tuples.join(',')}) AS v(id, qty)
       WHERE pc.id = v.id
```

### L346

```sql
SELECT id, name, price_cents, square_variation_id
       FROM products_cache
       WHERE id = ANY($1::text[])
```

### L380

```sql
SELECT id, square_customer_id FROM customers WHERE email = $1
```

### L421

```sql
UPDATE customers SET square_customer_id = $1, updated_at = NOW() WHERE id = $2
```

### L429

```sql
INSERT INTO customers (id, email, phone, first_name, last_name, square_customer_id, created_at, updated_at)
                 VALUES ($1, $2, $3, $4, $5, $6, NOW(), NOW())
```

### L479

```sql
INSERT INTO customers (id, email, phone, first_name, last_name, created_at, updated_at)
                 VALUES ($1, $2, $3, $4, $5, NOW(), NOW())
```

### L514

```sql
UPDATE customers SET square_customer_id = $1, updated_at = NOW() WHERE id = $2 AND square_customer_id IS NULL
```

### L667

```sql
INSERT INTO orders (
            id,
            customer_id,
            order_number, 
            square_order_id, 
            square_payment_id, 
            total_cents, 
            status, 
            pickup_details,
            created_at
          ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, NOW())
```

### L710

```sql
WITH v(item_id, order_id, product_id, quantity, price_cents, name) AS (
               VALUES ${tuples.join(',')}
             )
             INSERT INTO order_items (id, order_id, product_id, quantity, price_cents, name, created_at)
             SELECT
               v.item_id,
               v.order_id,
               pc.id, -- NULL when no matching product exists
               v.quantity,
               v.price_cents,
               v.name,
               NOW()
             FROM v
             LEFT JOIN products_cache pc ON pc.id = v.product_id
```

---

## `api/products.js` (3)

### L39

```sql
SELECT EXISTS (
      SELECT FROM information_schema.tables 
      WHERE table_schema = 'public' 
      AND table_name = 'albums_cache'
    ) as exists
```

### L153

```sql
SELECT 
          id,
          name,
          description,
          price_dollars,
          category,
          all_categories,
          stock_count,
          image_url,
          rating,
          review_count,
          sold_count,
          last_sold_at,
          last_stocked_at,
          last_adjustment_at,
          created_at
        FROM albums_cache
        WHERE 
          -- Stock filtering: show products with stock OR recently stocked
          stock_count > 0
          OR
          (
            stock_count = 0 
            AND (
              -- Prefer generated column if present; fall back to COALESCE for older schemas.
              (last_active_at IS NOT NULL AND last_active_at >= $1::timestamptz)
              OR
              (last_active_at IS NULL AND COALESCE(last_stocked_at, created_at) >= $1::timestamptz)
            )
          )
        ORDER BY created_at DESC, id ASC
```

### L230

```sql
SELECT 
          id,
          name,
          description,
          price_dollars,
          category,
          all_categories,
          stock_count,
          image_url,
          rating,
          review_count,
          sold_count,
          last_sold_at,
          last_stocked_at,
          last_adjustment_at,
          created_at
        FROM products_cache
        WHERE 
          (
            category = ANY($1::text[])
            OR 'New Vinyl' = ANY(all_categories)
            OR 'Used Vinyl' = ANY(all_categories)
            OR category IS NULL
          )
          AND (category IS NULL OR category != ALL($2::text[]))
          AND NOT ('DVD' = ANY(all_categories) OR 'DVDs' = ANY(all_categories) OR 'DVD''s' = ANY(all_categories))
          AND NOT ('Videogames' = ANY(all_categories))
          AND (
            stock_count > 0
            OR
            (
              stock_count = 0 
              AND (
                (last_stocked_at IS NOT NULL AND last_stocked_at >= $3::timestamptz)
                OR
                (last_stocked_at IS NULL AND created_at >= $3::timestamptz)
              )
            )
          )
        ORDER BY created_at DESC, id ASC
```

---

## `api/sales/best-sellers.js` (1)

### L40

```sql
SELECT
        pc.id AS product_id,
        pc.name AS product_name,
        pc.category,
        pc.image_url,
        SUM(sli.quantity)::bigint AS qty_sold,
        MAX(sli.order_created_at) AS last_sold_at
      FROM sales_line_items sli
      JOIN products_cache pc
        ON pc.id = ('variation-' || sli.square_catalog_object_id)
      WHERE sli.order_created_at >= (NOW() - ($1::int * INTERVAL '1 day'))
        AND COALESCE(pc.name, '') !~ '^\\s*1\\s*-\\s*' -- filter Square POS generic items
      GROUP BY pc.id, pc.name, pc.category, pc.image_url
      ORDER BY qty_sold DESC, last_sold_at DESC
      LIMIT $2::int
```

---

## `api/signup.js` (2)

### L87

```sql
SELECT id FROM users WHERE email = $1
```

### L108

```sql
INSERT INTO users (email, name, email_verified, created_at, updated_at)
         VALUES ($1, $2, FALSE, NOW(), NOW())
         RETURNING id
```

---

## `api/square/sales-sync.js` (14)

### L57

```sql
CREATE TABLE IF NOT EXISTS sales_orders (
      square_order_id TEXT PRIMARY KEY,
      location_id TEXT,
      state TEXT,
      customer_id TEXT,
      source TEXT,
      currency TEXT,
      total_money BIGINT,
      total_tax_money BIGINT,
      total_discount_money BIGINT,
      total_tip_money BIGINT,
      created_at TIMESTAMPTZ,
      updated_at TIMESTAMPTZ,
      closed_at TIMESTAMPTZ,
      raw JSONB,
      ingested_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    )
```

### L77

```sql
CREATE INDEX IF NOT EXISTS sales_orders_created_at_idx ON sales_orders (created_at DESC)
```

### L79

```sql
CREATE TABLE IF NOT EXISTS sales_line_items (
      id BIGSERIAL PRIMARY KEY,
      square_order_id TEXT NOT NULL REFERENCES sales_orders(square_order_id) ON DELETE CASCADE,
      square_line_item_uid TEXT NOT NULL,
      square_catalog_object_id TEXT,
      name TEXT,
      quantity INTEGER NOT NULL DEFAULT 0,
      currency TEXT,
      gross_sales_money BIGINT,
      total_money BIGINT,
      order_created_at TIMESTAMPTZ,
      order_closed_at TIMESTAMPTZ,
      raw JSONB,
      ingested_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
      UNIQUE(square_order_id, square_line_item_uid)
    )
```

### L98

```sql
CREATE INDEX IF NOT EXISTS sales_line_items_catalog_object_idx ON sales_line_items (square_catalog_object_id)
```

### L99

```sql
CREATE INDEX IF NOT EXISTS sales_line_items_order_created_at_idx ON sales_line_items (order_created_at DESC)
```

### L101

```sql
CREATE TABLE IF NOT EXISTS sales_sync_state (
      key TEXT PRIMARY KEY,
      last_synced_at TIMESTAMPTZ,
      updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    )
```

### L156

```sql
INSERT INTO sales_orders (
      square_order_id, location_id, state, customer_id, source, currency,
      total_money, total_tax_money, total_discount_money, total_tip_money,
      created_at, updated_at, closed_at, raw
    )
    VALUES ${rows.join(',')}
    ON CONFLICT (square_order_id) DO UPDATE SET
      location_id = EXCLUDED.location_id,
      state = EXCLUDED.state,
      customer_id = EXCLUDED.customer_id,
      source = EXCLUDED.source,
      currency = EXCLUDED.currency,
      total_money = EXCLUDED.total_money,
      total_tax_money = EXCLUDED.total_tax_money,
      total_discount_money = EXCLUDED.total_discount_money,
      total_tip_money = EXCLUDED.total_tip_money,
      created_at = COALESCE(EXCLUDED.created_at, sales_orders.created_at),
      updated_at = COALESCE(EXCLUDED.updated_at, sales_orders.updated_at),
      closed_at = COALESCE(EXCLUDED.closed_at, sales_orders.closed_at),
      raw = EXCLUDED.raw,
      ingested_at = NOW()
```

### L234

```sql
INSERT INTO sales_line_items (
        square_order_id, square_line_item_uid, square_catalog_object_id, name,
        quantity, currency, gross_sales_money, total_money,
        order_created_at, order_closed_at, raw
      )
      VALUES ${rebuiltRows.join(',')}
      ON CONFLICT (square_order_id, square_line_item_uid) DO NOTHING
      RETURNING square_catalog_object_id, quantity, order_created_at
```

### L286

```sql
UPDATE products_cache pc
     SET sold_count = COALESCE(pc.sold_count, 0) + v.qty,
         last_sold_at = CASE
           WHEN v.sold_at IS NULL THEN pc.last_sold_at
           WHEN pc.last_sold_at IS NULL THEN v.sold_at
           ELSE GREATEST(pc.last_sold_at, v.sold_at)
         END
     FROM (VALUES ${tuples.join(',')}) AS v(id, qty, sold_at)
     WHERE pc.id = v.id
```

### L301

```sql
SELECT last_synced_at FROM sales_sync_state WHERE key='square_orders' LIMIT 1
```

### L307

```sql
INSERT INTO sales_sync_state (key, last_synced_at)
     VALUES ('square_orders', $1::timestamptz)
     ON CONFLICT (key) DO UPDATE SET last_synced_at=EXCLUDED.last_synced_at, updated_at=NOW()
```

### L364

```sql
INSERT INTO sync_log (sync_type, status, started_at, metadata)
        VALUES ('sales', 'running', NOW(), $1::jsonb)
        RETURNING id
```

### L463

```sql
UPDATE sync_log 
          SET status = 'success',
              completed_at = NOW(),
              duration_ms = $1,
              items_processed = $2,
              items_created = $3,
              metadata = COALESCE(metadata, '{}'::jsonb) || $4::jsonb
          WHERE id = $5
```

### L507

```sql
UPDATE sync_log 
          SET status = 'error',
              completed_at = NOW(),
              duration_ms = $1,
              error_message = $2
          WHERE id = $3
```

---

## `api/square/sync.js` (3)

### L68

```sql
INSERT INTO sync_log (sync_type, status, started_at, metadata)
        VALUES ('products', 'running', NOW(), $1::jsonb)
        RETURNING id
```

### L108

```sql
UPDATE sync_log 
          SET status = 'success',
              completed_at = NOW(),
              duration_ms = $1,
              items_processed = $2,
              items_created = COALESCE($3, 0),
              items_updated = COALESCE($4, 0),
              metadata = COALESCE(metadata, '{}'::jsonb) || $5::jsonb
          WHERE id = $6
```

### L150

```sql
UPDATE sync_log 
          SET status = 'error',
              completed_at = NOW(),
              duration_ms = $1,
              error_message = $2
          WHERE id = $3
```

---

## `api/squareSync.js` (9)

### L20

```sql
CREATE TABLE IF NOT EXISTS products_cache (
      id TEXT PRIMARY KEY,
      square_item_id TEXT,
      square_variation_id TEXT,
      name TEXT NOT NULL,
      description TEXT,
      price_cents BIGINT NOT NULL DEFAULT 0,
      category TEXT,
      all_categories TEXT[],
      stock_count INTEGER NOT NULL DEFAULT 0,
      image_url TEXT,
      rating NUMERIC,
      review_count INTEGER,
      created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
    )
```

### L41

```sql
SELECT 1 FROM information_schema.columns WHERE table_name='products_cache' AND column_name='price_dollars' LIMIT 1
```

### L45

```sql
ALTER TABLE products_cache
       ADD COLUMN price_dollars NUMERIC GENERATED ALWAYS AS (price_cents / 100.0) STORED
```

### L52

```sql
ALTER TABLE products_cache ADD COLUMN IF NOT EXISTS sold_count INTEGER NOT NULL DEFAULT 0
```

### L53

```sql
ALTER TABLE products_cache ADD COLUMN IF NOT EXISTS last_sold_at TIMESTAMPTZ
```

### L54

```sql
ALTER TABLE products_cache ADD COLUMN IF NOT EXISTS last_stocked_at TIMESTAMPTZ
```

### L55

```sql
ALTER TABLE products_cache ADD COLUMN IF NOT EXISTS last_adjustment_at TIMESTAMPTZ
```

### L339

```sql
INSERT INTO products_cache (
         id,
         square_item_id,
         square_variation_id,
         name,
         description,
         price_cents,
         category,
         all_categories,
         stock_count,
         image_url,
         rating,
         review_count,
         created_at,
         updated_at,
         last_stocked_at
       ) VALUES (
         $1,$2,$3,$4,$5,$6,$7,$8,$9,$10,
         COALESCE((SELECT rating FROM products_cache WHERE id = $1), 0),
         COALESCE((SELECT review_count FROM products_cache WHERE id = $1), 0),
         COALESCE($11::timestamptz, CURRENT_TIMESTAMP),
         COALESCE($12::timestamptz, CURRENT_TIMESTAMP),
         CASE 
           WHEN $9 > 0 THEN CURRENT_TIMESTAMP
           ELSE (SELECT last_stocked_at FROM products_cache WHERE id = $1)
         END
       )
       ON CONFLICT (id) DO UPDATE SET
         square_item_id = EXCLUDED.square_item_id,
         square_variation_id = EXCLUDED.square_variation_id,
         name = EXCLUDED.name,
         description = EXCLUDED.description,
         price_cents = EXCLUDED.price_cents,
         category = EXCLUDED.category,
         all_categories = EXCLUDED.all_categories,
         stock_count = EXCLUDED.stock_count,
         image_url = EXCLUDED.image_url,
         -- Preserve original created_at (don't overwrite on updates)
         -- Only set created_at if it doesn't exist yet (new product)
         created_at = COALESCE(products_cache.created_at, EXCLUDED.created_at),
         updated_at = EXCLUDED.updated_at,
         last_stocked_at = CASE
           -- If stock went from 0 (or null) to > 0, update last_stocked_at
           WHEN EXCLUDED.stock_count > 0 AND (products_cache.stock_count IS NULL OR products_cache.stock_count = 0) THEN CURRENT_TIMESTAMP
           -- If stock increased (but was already > 0), update last_stocked_at
           WHEN EXCLUDED.stock_count > products_cache.stock_count AND products_cache.stock_count > 0 THEN CURRENT_TIMESTAMP
           -- Otherwise keep existing value
           ELSE products_cache.last_stocked_at
         END
```

### L417

```sql
DELETE FROM products_cache 
         WHERE square_variation_id IS NOT NULL 
         AND square_variation_id != ''
         AND square_variation_id NOT IN (${placeholders})
```

---

## `api/staff-picks.js` (1)

### L28

```sql
SELECT
         id,
         square_item_id,
         square_variation_id,
         name,
         quote,
         created_at
       FROM staff_picks
       ORDER BY created_at DESC
       LIMIT $1
```

---

## `api/weekly-newsletter-bulk.js` (6)

### L27

```sql
SELECT 
          email, 
          first_name, 
          last_name,
          subscribed
        FROM email_list
        WHERE subscribed = TRUE
          AND email IS NOT NULL
          AND email != ''
        ORDER BY created_at DESC
```

### L41

```sql
SELECT 
          email, 
          "firstName" as first_name, 
          "lastName" as last_name,
          subscribed
        FROM email_list
        WHERE subscribed = TRUE
          AND email IS NOT NULL
          AND email != ''
        ORDER BY "createdAt" DESC
```

### L116

```sql
INSERT INTO sync_log (sync_type, status, started_at, metadata)
        VALUES ('weekly_newsletter', 'running', NOW(), $1::jsonb)
        RETURNING id
```

### L142

```sql
UPDATE sync_log 
            SET status = 'success',
                completed_at = NOW(),
                duration_ms = $1,
                items_processed = 0,
                metadata = COALESCE(metadata, '{}'::jsonb) || $2::jsonb
            WHERE id = $3
```

### L229

```sql
UPDATE sync_log 
          SET status = ${errorCount === 0 ? "'success'" : "'error'"},
              completed_at = NOW(),
              duration_ms = $1,
              items_processed = $2,
              items_created = $3,
              error_message = ${errors.length > 0 ? '$4' : 'NULL'},
              metadata = COALESCE(metadata, '{}'::jsonb) || $5::jsonb
          WHERE id = $6
```

### L324

```sql
UPDATE sync_log 
          SET status = 'error',
              completed_at = NOW(),
              duration_ms = $1,
              error_message = $2
          WHERE id = $3
```

---

## `api/weekly-newsletter.js` (5)

### L31

```sql
SELECT
        id,
        event_name,
        artist,
        venue,
        event_date,
        start_time
      FROM events
      WHERE is_event = true
        AND event_date >= CURRENT_DATE
        AND event_date <= $1::date
      ORDER BY event_date ASC, start_time ASC NULLS LAST
      LIMIT 10
```

### L94

```sql
SELECT
        id,
        name,
        description,
        price_dollars AS price,
        category,
        image_url,
        stock_count,
        created_at
      FROM products_cache
      WHERE stock_count > 0
        AND created_at >= NOW() - INTERVAL '30 days'
        AND (
          category IN ('New Vinyl', 'Used Vinyl', '33New', '33Used', '45', 'LP', '12"', '7"', '10"')
          OR category ILIKE '%vinyl%'
          OR category ILIKE '%LP%'
          OR category ILIKE '%12"%'
          OR category ILIKE '%7"%'
          OR category ILIKE '%10"%'
          OR category ILIKE '%45%'
        )
      ORDER BY created_at DESC NULLS LAST
      LIMIT 30
```

### L135

```sql
SELECT pickup_details
      FROM orders
      WHERE LOWER(COALESCE(pickup_details->>'email', '')) = LOWER($1)
        AND status NOT IN ('CANCELLED', 'CANCELED')
      ORDER BY created_at DESC
      LIMIT 10
```

### L170

```sql
SELECT
          id,
          name,
          description,
          price_dollars AS price,
          category,
          image_url,
          stock_count
        FROM products_cache
        WHERE stock_count > 0
          AND id != ALL($1::text[])
          AND (
            category IN ('New Vinyl', 'Used Vinyl', '33New', '33Used', '45', 'LP', '12"', '7"', '10"')
            OR category ILIKE '%vinyl%'
            OR category ILIKE '%LP%'
            OR category ILIKE '%12"%'
            OR category ILIKE '%7"%'
            OR category ILIKE '%10"%'
            OR category ILIKE '%45%'
          )
          ${categoryArray.length > 0 ?
```

### L219

```sql
SELECT
        id,
        name,
        description,
        price_dollars AS price,
        category,
        image_url,
        stock_count
      FROM products_cache
      WHERE stock_count > 0
        AND (
          category IN ('New Vinyl', 'Used Vinyl', '33New', '33Used', '45', 'LP', '12"', '7"', '10"')
          OR category ILIKE '%vinyl%'
          OR category ILIKE '%LP%'
          OR category ILIKE '%12"%'
          OR category ILIKE '%7"%'
          OR category ILIKE '%10"%'
          OR category ILIKE '%45%'
        )
      ORDER BY sold_count DESC, created_at DESC
      LIMIT 12
```

---

## `scripts/add-created-at-index.mjs` (6)

### L11

```sql
SELECT indexname
      FROM pg_indexes
      WHERE tablename = 'products_cache' 
        AND indexname = 'idx_products_cache_created_at'
```

### L20

```sql
CREATE INDEX idx_products_cache_created_at 
        ON products_cache (created_at DESC)
```

### L30

```sql
SELECT indexname
      FROM pg_indexes
      WHERE tablename = 'albums_cache' 
        AND indexname = 'idx_albums_cache_created_at'
```

### L39

```sql
CREATE INDEX idx_albums_cache_created_at 
        ON albums_cache (created_at DESC)
```

### L50

```sql
ANALYZE products_cache
```

### L51

```sql
ANALYZE albums_cache
```

---

## `scripts/add-events-indexes.mjs` (5)

### L52

```sql
CREATE INDEX IF NOT EXISTS events_is_event_date_idx 
      ON events (is_event, event_date ASC)
      WHERE is_event = true
```

### L63

```sql
CREATE INDEX IF NOT EXISTS events_event_date_idx 
      ON events (event_date ASC)
```

### L71

```sql
CREATE INDEX IF NOT EXISTS events_is_event_idx 
      ON events (is_event)
      WHERE is_event = true
```

### L80

```sql
CREATE INDEX IF NOT EXISTS events_date_time_sort_idx 
      ON events (event_date ASC, start_time ASC, id ASC)
      WHERE is_event = true
```

### L91

```sql
ANALYZE events
```

---

## `scripts/create-sync-log-table.mjs` (3)

### L25

```sql
CREATE TABLE IF NOT EXISTS sync_log (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        sync_type TEXT NOT NULL,
        status TEXT NOT NULL,
        started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        completed_at TIMESTAMPTZ,
        duration_ms INTEGER,
        items_processed INTEGER,
        items_created INTEGER,
        items_updated INTEGER,
        error_message TEXT,
        metadata JSONB,
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
      )
```

### L43

```sql
CREATE INDEX IF NOT EXISTS idx_sync_log_type_created 
      ON sync_log(sync_type, created_at DESC)
```

### L49

```sql
CREATE INDEX IF NOT EXISTS idx_sync_log_status 
      ON sync_log(status, created_at DESC)
```

---

## `scripts/optimize-database-performance.mjs` (25)

### L13

```sql
CREATE INDEX IF NOT EXISTS idx_staff_picks_square_variation_id 
      ON staff_picks (square_variation_id)
```

### L17

```sql
CREATE INDEX IF NOT EXISTS idx_staff_picks_square_item_id 
      ON staff_picks (square_item_id)
```

### L21

```sql
CREATE INDEX IF NOT EXISTS idx_staff_picks_created_at 
      ON staff_picks (created_at DESC)
```

### L29

```sql
CREATE INDEX IF NOT EXISTS idx_albums_cache_square_item_id 
      ON albums_cache (square_item_id)
```

### L37

```sql
CREATE INDEX IF NOT EXISTS idx_albums_cache_stock_date_composite 
      ON albums_cache (stock_count, last_stocked_at, created_at DESC)
      WHERE stock_count = 0
```

### L42

```sql
CREATE INDEX IF NOT EXISTS idx_albums_cache_stock_positive 
      ON albums_cache (created_at DESC, id ASC)
      WHERE stock_count > 0
```

### L51

```sql
CREATE INDEX IF NOT EXISTS idx_events_created_at 
      ON events (created_at DESC)
```

### L59

```sql
CREATE INDEX IF NOT EXISTS idx_order_items_order_id 
      ON order_items (order_id)
```

### L63

```sql
CREATE INDEX IF NOT EXISTS idx_order_items_product_id 
      ON order_items (product_id)
```

### L67

```sql
CREATE INDEX IF NOT EXISTS idx_order_items_created_at 
      ON order_items (created_at DESC)
```

### L80

```sql
CREATE INDEX IF NOT EXISTS idx_orders_order_number
      ON orders (order_number)
```

### L84

```sql
CREATE INDEX IF NOT EXISTS idx_orders_square_order_id
      ON orders (square_order_id)
```

### L88

```sql
CREATE INDEX IF NOT EXISTS idx_orders_created_at_desc
      ON orders (created_at DESC)
```

### L92

```sql
CREATE INDEX IF NOT EXISTS idx_orders_pickup_email_lower
      ON orders ((lower(coalesce(pickup_details->>'email',''))))
```

### L96

```sql
CREATE INDEX IF NOT EXISTS idx_orders_pickup_phone
      ON orders ((coalesce(pickup_details->>'phone','')))
```

### L104

```sql
CREATE INDEX IF NOT EXISTS idx_customers_email
      ON customers (email)
```

### L108

```sql
CREATE INDEX IF NOT EXISTS idx_customers_square_customer_id
      ON customers (square_customer_id)
```

### L116

```sql
ANALYZE products_cache
```

### L117

```sql
ANALYZE albums_cache
```

### L118

```sql
ANALYZE staff_picks
```

### L119

```sql
ANALYZE events
```

### L120

```sql
ANALYZE order_items
```

### L121

```sql
ANALYZE orders
```

### L122

```sql
ANALYZE customers
```

### L127

```sql
SELECT 
        tablename,
        indexname
      FROM pg_indexes
      WHERE schemaname = 'public'
        AND tablename IN ('staff_picks', 'albums_cache', 'events', 'order_items', 'orders', 'customers')
      ORDER BY tablename, indexname
```

---

## `scripts/optimize-products-cache-indexes.mjs` (3)

### L59

```sql
SELECT indexname
    FROM pg_indexes
    WHERE tablename = 'products_cache'
    ORDER BY indexname
```

### L97

```sql
DROP INDEX IF EXISTS ${indexName}
```

### L125

```sql
ANALYZE products_cache
```

---

## `scripts/send-weekly-newsletter.mjs` (2)

### L73

```sql
SELECT 
          email, 
          first_name, 
          last_name,
          subscribed
        FROM email_list
        WHERE subscribed = TRUE
          AND email IS NOT NULL
          AND email != ''
          AND (unsubscribed_at IS NULL OR unsubscribed_at IS NULL)
        ORDER BY created_at DESC
```

### L89

```sql
SELECT 
            email, 
            "firstName" as first_name, 
            "lastName" as last_name,
            subscribed
          FROM email_list
          WHERE subscribed = TRUE
            AND email IS NOT NULL
            AND email != ''
          ORDER BY "createdAt" DESC
```

---

## `scripts/test-emails.mjs` (4)

### L65

```sql
INSERT INTO email_list (email, first_name, last_name, source, subscribed, created_at, updated_at)
           VALUES ($1, $2, $3, $4, TRUE, NOW(), NOW())
           ON CONFLICT (email) 
           DO UPDATE SET 
             first_name = COALESCE(EXCLUDED.first_name, email_list.first_name),
             last_name = COALESCE(EXCLUDED.last_name, email_list.last_name),
             subscribed = TRUE,
             updated_at = NOW()
```

### L96

```sql
SELECT id FROM users WHERE email = $1
```

### L103

```sql
INSERT INTO users (email, name, email_verified, created_at, updated_at)
           VALUES ($1, $2, FALSE, NOW(), NOW())
```

### L172

```sql
INSERT INTO password_reset_tokens (user_id, email, token, expires_at, used, created_at)
           VALUES ($1, $2, $3, $4, FALSE, NOW())
```

---

## `scripts/validate-staff-picks.mjs` (2)

### L12

```sql
SELECT 
        id,
        square_item_id,
        square_variation_id,
        name,
        quote,
        created_at
      FROM staff_picks
      ORDER BY created_at DESC
```

### L34

```sql
SELECT 
        id,
        square_variation_id,
        name
      FROM products_cache
      WHERE square_variation_id = ANY($1::text[])
```

